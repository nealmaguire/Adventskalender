<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Rätsel-Adventskalender — Starter</title>
  <style>
    :root{--gap:10px;--door-size:96px}
    html,body{height:100%;}
    body{
      font-family:Inter,system-ui,Arial,sans-serif;margin:0;padding:18px;color:#111;
      background-image: url('https://images.unsplash.com/photo-1549576490-b0b4831ef60a?auto=format&fit=crop&w=1400&q=80');
      background-size:cover;background-position:center center;background-attachment:fixed;
    }
    .overlay{background:linear-gradient(rgba(0,0,0,0.45),rgba(0,0,0,0.35));min-height:100%;padding:18px;border-radius:8px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{font-size:1.2rem;margin:0;color:#fff}
    .controls{display:flex;gap:8px;align-items:center}
    input[type="number"]{width:64px;padding:6px}

    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:var(--gap);max-width:920px;margin-top:18px}

    /* Tür-Optik: nur eine Nummer in der Mitte */
    .door{
      height:var(--door-size);display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#b71c1c,#e53935);border-radius:12px;border:2px solid rgba(255,209,102,0.95);cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.45);font-weight:900;color:white;position:relative;overflow:visible}
    .door.locked{display:none}
    .door.opened{background:linear-gradient(180deg,#2e7d32,#66bb6a)}
    .door-number{font-size:1.6rem;line-height:1;display:inline-block;padding:0;margin:0}

    /* door-clone used for open-through-door animation */
    .door-clone{position:fixed;left:0;top:0;width:var(--door-size);height:var(--door-size);border-radius:12px;background:linear-gradient(180deg,#b71c1c,#e53935);box-shadow:0 18px 40px rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900}

    #puzzleBox{margin-top:18px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.95);border:1px solid #e0e6f0;max-width:920px;z-index:6;position:relative}
    label{display:block;margin:8px 0}
    input[type=text], textarea{width:100%;padding:8px;border:1px solid #ccd5ea;border-radius:6px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#2b6cff;color:white;cursor:pointer}
    button.secondary{background:#6b7280}
    table{border-collapse:collapse;width:100%;margin-top:12px}
    table th, table td{border:1px solid #e6e9f2;padding:6px;text-align:left}
    .top-right{font-size:0.9rem;color:#fff}
    .note{color:#fff;font-size:0.95rem}

    @media (max-width:720px){:root{--door-size:72px}.grid{grid-template-columns:repeat(3,1fr)}}
  </style>
</head>
<body>
  <div class="overlay">
  <header>
    <div>
      <h1>Rätsel-Adventskalender — Starter</h1>
      <div class="note">Die Türchen erscheinen täglich ab dem 1. Dezember. Vor dem 1.12. sind keine Türchen sichtbar.</div>
    </div>
    <div class="controls top-right">
      <label style="display:flex;align-items:center;gap:8px;color:#fff">
        Aktiver Tag
        <input id="activeDayInput" type="number" min="0" max="24" value="0" title="0-24" />
      </label>
      <label style="display:flex;align-items:center;gap:6px;color:#fff">
        <input id="useRealDate" type="checkbox" checked /> Echt-Datum
      </label>
      <button id="adminBtn" class="secondary">Admin</button>
    </div>
  </header>

  <main>
    <div id="gridContainer">
      <div class="grid" id="grid"></div>
    </div>

    <div id="puzzleBox" style="display:none">
      <h3 id="puzzleTitle">Rätsel</h3>
      <div id="puzzleContent">Platzhalter für Rätsel (Text, Bild, Audio, Link etc.).</div>

      <label>Dein Name (sichtbar):
        <input id="nameField" type="text" placeholder="z. B. Anna" />
      </label>
      <label>Antwort (optional):
        <textarea id="answerField" rows="3" placeholder="Antwort eingeben..."></textarea>
      </label>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="saveBtn">Absenden</button>
        <button id="closeBtn" class="secondary">Schließen</button>
        <div id="saveMsg" style="color:green;margin-left:8px"></div>
      </div>
    </div>

    <div id="adminPanel" style="display:none;margin-top:12px">
      <h3 style="color:#fff">Admin — Einsendungen</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="downloadCsv">CSV herunterladen</button>
        <button id="clearData" class="secondary">Alles löschen</button>
        <button id="closeAdmin" class="secondary">Schließen</button>
      </div>
      <div id="submissionsTableWrap"></div>
    </div>
  </main>
  </div>

<script>
// ------------------ Advent prototype (fixed numbers + open-through animation) ------------------
const GRID = document.getElementById('grid');
const activeDayInput = document.getElementById('activeDayInput');
const useRealDate = document.getElementById('useRealDate');
const puzzleBox = document.getElementById('puzzleBox');
const puzzleTitle = document.getElementById('puzzleTitle');
const puzzleContent = document.getElementById('puzzleContent');
const nameField = document.getElementById('nameField');
const answerField = document.getElementById('answerField');
const saveBtn = document.getElementById('saveBtn');
const closeBtn = document.getElementById('closeBtn');
const saveMsg = document.getElementById('saveMsg');
const adminBtn = document.getElementById('adminBtn');
const adminPanel = document.getElementById('adminPanel');
const submissionsTableWrap = document.getElementById('submissionsTableWrap');
const downloadCsv = document.getElementById('downloadCsv');
const clearData = document.getElementById('clearData');
const closeAdmin = document.getElementById('closeAdmin');

let activeDay = 0;
let openedDay = null;

function computeActiveDayFromDate(){
  const now = new Date();
  const year = now.getFullYear();
  const dec1 = new Date(year,11,1,0,0,0);
  const dec24 = new Date(year,11,24,23,59,59);
  if(now < dec1) return 0;
  if(now > dec24) return 24;
  return Math.min(24, now.getDate());
}

function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function renderGrid(){
  GRID.innerHTML = '';
  if(activeDay === 0){
    const placeholder = document.createElement('div');
    placeholder.style.gridColumn = '1/-1';
    placeholder.style.color = '#fff';
    placeholder.style.padding = '18px';
    placeholder.innerHTML = '<strong>Die Türchen erscheinen am 1. Dezember.</strong>';
    GRID.appendChild(placeholder);
    return;
  }

  // numbers 1..24 in order (we'll only show 1..activeDay)
  const nums = [];
  for(let d=1; d<=24; d++) nums.push(d);
  // shuffle positions array to place numbers randomly in grid cells
  const positions = shuffle(nums.slice());

  for(let i=0; i<nums.length; i++){
    const day = nums[i];
    const el = document.createElement('div');
    el.className = 'door';
    // place the single centered number
    el.innerHTML = `<span class="door-number">${day}</span>`;
    el.dataset.day = day;
    // if locked, hide entirely
    if(day <= activeDay){
      el.addEventListener('click', ()=> onDoorClick(day, el));
    } else {
      el.classList.add('locked');
    }
    GRID.appendChild(el);
  }
}

function onDoorClick(day, el){
  if(day > activeDay){ alert('Noch gesperrt.'); return; }
  // open-through-door animation
  animateDoorOpen(el, day);
}

function animateDoorOpen(el, day){
  // clone source element and animate to fullscreen, then show puzzle
  const rect = el.getBoundingClientRect();
  const clone = el.cloneNode(true);
  clone.classList.add('door-clone');
  // initial placement
  clone.style.left = rect.left + 'px';
  clone.style.top = rect.top + 'px';
  clone.style.width = rect.width + 'px';
  clone.style.height = rect.height + 'px';
  clone.style.borderRadius = window.getComputedStyle(el).borderRadius;
  document.body.appendChild(clone);

  // target: center, large
  const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
  const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
  const targetW = Math.max(vw * 0.9, vw);
  const targetH = Math.max(vh * 0.9, vh);
  const targetLeft = (vw - targetW) / 2;
  const targetTop = (vh - targetH) / 2;

  const anim = clone.animate([
    { left: rect.left + 'px', top: rect.top + 'px', width: rect.width + 'px', height: rect.height + 'px', transform: 'none' },
    { left: targetLeft + 'px', top: targetTop + 'px', width: targetW + 'px', height: targetH + 'px', transform: 'none' }
  ], { duration: 650, easing: 'cubic-bezier(.2,.9,.3,1)', fill: 'forwards' });

  anim.onfinish = ()=>{
    // show puzzle and remove clone
    showPuzzleForDay(day);
    clone.remove();
  };
}

function showPuzzleForDay(day){
  puzzleTitle.textContent = `Rätsel — Tag ${day}`;
  puzzleContent.innerHTML = `<p>Hier kannst du ein Rätsel, ein Bild oder einen Link für Tag ${day} einfügen.</p>`;
  const meta = loadMeta(); if(meta && meta.lastName) nameField.value = meta.lastName;
  answerField.value = '';
  saveMsg.textContent = '';
  puzzleBox.style.display = 'block';
  window.scrollTo({top: puzzleBox.offsetTop - 20, behavior:'smooth'});
}

closeBtn.addEventListener('click', ()=>{ puzzleBox.style.display='none'; openedDay=null; });

function loadSubmissions(){
  try{ const raw = localStorage.getItem('advent_submissions'); if(!raw) return []; return JSON.parse(raw); }catch(e){ return []; }
}
function saveSubmissions(arr){ localStorage.setItem('advent_submissions', JSON.stringify(arr)); }
function loadMeta(){ try{ return JSON.parse(localStorage.getItem('advent_meta')||'{}'); }catch(e){return{}}; }
function saveMeta(obj){ localStorage.setItem('advent_meta', JSON.stringify(obj)); }

saveBtn.addEventListener('click', ()=>{
  const name = nameField.value.trim();
  const ans = answerField.value.trim();
  if(!name){ alert('Bitte Namen eingeben (sichtbar).'); return; }
  const subs = loadSubmissions();
  subs.push({ day: openedDay, name, answer: ans, ts: new Date().toISOString() });
  saveSubmissions(subs);
  saveMeta({ lastName: name });
  saveMsg.textContent = 'Gespeichert ✓';
  markDoorOpened(openedDay);
});

function markDoorOpened(day){
  const el = GRID.querySelector(`[data-day="${day}"]`);
  if(el) el.classList.add('opened');
}

adminBtn.addEventListener('click', ()=>{
  const pass = prompt('Admin öffnen — Passwort? (Standard: "admin")');
  if(pass === null) return;
  if(pass !== 'admin') { alert('Falsches Passwort'); return; }
  renderAdmin();
  adminPanel.style.display = 'block';
  window.scrollTo({top: adminPanel.offsetTop - 10, behavior:'smooth'});
});

closeAdmin.addEventListener('click', ()=>{ adminPanel.style.display = 'none'; });

function renderAdmin(){
  const subs = loadSubmissions();
  if(subs.length === 0){ submissionsTableWrap.innerHTML = '<p style="color:#fff">Keine Einsendungen.</p>'; return; }
  let html = '<table><thead><tr><th>Tag</th><th>Name</th><th>Antwort</th><th>Zeitstempel</th></tr></thead><tbody>';
  for(const s of subs){ html += `<tr><td>${s.day}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.answer)}</td><td>${s.ts}</td></tr>`; }
  html += '</tbody></table>';
  submissionsTableWrap.innerHTML = html;
}

downloadCsv.addEventListener('click', ()=>{
  const subs = loadSubmissions(); if(subs.length === 0){ alert('Keine Einsendungen.'); return; }
  const rows = [['day','name','answer','timestamp']]; for(const s of subs) rows.push([s.day, s.name, s.answer, s.ts]);
  const csv = rows.map(r => r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',' )).join('
');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='submissions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

clearData.addEventListener('click', ()=>{
  if(!confirm('Wirklich alle lokalen Einsendungen löschen?')) return; localStorage.removeItem('advent_submissions'); localStorage.removeItem('advent_meta'); renderAdmin(); alert('Gelöscht.');
});

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function init(){
  if(useRealDate.checked){
    activeDay = computeActiveDayFromDate();
    activeDayInput.value = activeDay;
    activeDayInput.disabled = true;
  } else {
    activeDay = parseInt(activeDayInput.value,10) || 0;
  }
  renderGrid();
  const prev = loadSubmissions(); for(const s of prev){ if(s && s.day) markDoorOpened(s.day); }
}

activeDayInput.addEventListener('change', ()=>{ if(useRealDate.checked) return; activeDay = parseInt(activeDayInput.value,10) || 0; renderGrid(); });
useRealDate.addEventListener('change', ()=>{ if(useRealDate.checked){ activeDay = computeActiveDayFromDate(); activeDayInput.value = activeDay; activeDayInput.disabled = true; } else { activeDayInput.disabled = false; } renderGrid(); });

init();

</script>
</body>
</html>
